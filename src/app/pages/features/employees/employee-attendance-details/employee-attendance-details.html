<!-- Employee Attendance Reports -->
 <p-card header="Attendance Details" class="mb-4">
  <hr class="border-t border-gray-200 my-3" />
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-3">
    <label for="academic-year" class="font-bold mr-2">Month</label>
   <div class="flex flex-col">
   <p-datepicker 
        id="date" 
        [(ngModel)]="date" 
        view="month" 
        dateFormat="MM yy" 
        [showIcon]="true" 
        [minDate]="minDate" 
        [maxDate]="maxDate"
        [readonlyInput]="true"
        (onSelect)="updateGrid()" 
        class="w-auto">
    </p-datepicker>
   <small *ngIf="minDate && maxDate" class="text-xs text-gray-500">Academic year: {{ minDate | date:'MMM yyyy' }} - {{ maxDate | date:'MMM yyyy' }}</small>
   </div>
    </div>

    <div class="text-right">
      <div class="text-sm text-gray-600">Showing Attendance for</div>
      <div class="font-semibold">{{ date | date:'MMMM yyyy' }}</div>
    </div>
  </div>
</p-card>

<!-- Attendance Details Table -->
<p-card header="Attendance Records" class="mb-4">
  <p-table #dt
    [value]="attendanceData" 
    [loading]="loading"
    [paginator]="true" 
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [globalFilterFields]="getFilterFields()"
    styleClass="p-datatable-gridlines"
    [tableStyle]="{'min-width':'60rem'}">
    
    >
      <!-- Search + Date Filter -->
      <ng-template pTemplate="caption">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3 w-full">
          <p-datepicker
            [(ngModel)]="filterDate"
            view="date"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            [minDate]="minDate" 
            [maxDate]="maxDate"
            [defaultDate]="minDate"
            (onSelect)="onDateFilter()"
            placeholder="Filter by date"
            [readonlyInput]="true"
            class="sm:w-64 w-full">
          </p-datepicker>

          <span *ngIf="isSchoolAdmin" class="p-input-icon-left sm:ml-2 w-full sm:w-auto">
            <input
              #globalFilter
              pInputText
              type="text"
              placeholder="Search Employees..."
              (input)="filterTable($any($event.target).value)"
              class="sm:w-64 w-full" />
          </span>

          <div class="ml-auto mt-2 sm:mt-0 flex items-center gap-2">
            <p-button
              icon="pi pi-times"
              label="Clear"
              class="p-button-text"
              (onClick)="clearFilters()">
            </p-button>
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th class="sticky-col sticky-col-header" style="width:3rem;text-align:center">#</th>
          <th pSortableColumn="Date">
            Date
            <p-sortIcon field="Date"></p-sortIcon>
          </th>
          <th *ngIf="isSchoolAdmin" pSortableColumn="EmployeeName">
            Employee Name
            <p-sortIcon field="EmployeeName"></p-sortIcon>
          </th>
          <th pSortableColumn="SignInTime">
            Sign In
            <p-sortIcon field="SignInTime"></p-sortIcon>
          </th>
          <th pSortableColumn="SignOutTime">
            Sign Out
            <p-sortIcon field="SignOutTime"></p-sortIcon>
          </th>
          <th pSortableColumn="Status">
            Status
            <p-sortIcon field="Status"></p-sortIcon>
          </th>
          <th>Remarks</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-attendance let-i="rowIndex">
      <tr>
  <td class="sticky-col" style="text-align:center">{{ (dt.first || 0) + i + 1 }}</td>
        <td>{{ attendance.Date | date:'dd/MM/yyyy' }}</td>
        <td *ngIf="isSchoolAdmin">{{ attendance.EmployeeName }}</td>
        <td>
          <span [class]="getTimeStatusClass(attendance.SignInTime, 'signin')">
            {{ attendance.SignInTime ? formatTime(attendance.SignInTime) : 'Not Signed In' }}
          </span>
        </td>
        <td>
          <span [class]="getTimeStatusClass(attendance.SignOutTime, 'signout')">
            {{ attendance.SignOutTime ? formatTime(attendance.SignOutTime) : 'Not Signed Out' }}
          </span>
        </td>
        <td>
          <p-tag 
            [value]="attendance.Status" 
            [severity]="getStatusSeverity(attendance.Status)">
          </p-tag>
        </td>
        <td>
          <span class="text-sm">{{ attendance.Remarks || '-' }}</span>
        </td>
      </tr>
    </ng-template>

    <!-- Empty State -->
    <ng-template pTemplate="emptymessage">
      <tr>
  <td [attr.colspan]="isSchoolAdmin ? 7 : 6" class="text-center py-8">
          <div class="flex flex-col items-center gap-2">
            <i class="pi pi-calendar text-gray-400 text-4xl"></i>
            <p class="text-gray-500">No attendance records found for {{ date | date:'MMMM yyyy' }}</p>
          </div>
        </td>
      </tr>
    </ng-template>

  </p-table>
</p-card>

