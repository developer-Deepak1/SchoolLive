<!-- Academic Calendar Top Section -->
<p-card header="Academic Calendar" class="mb-4">
  <hr class="border-t border-gray-200 my-3" />
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-3">
      <label for="academic-year" class="font-bold mr-2">Academic Year</label>
      <p-select inputId="academic-year" [(ngModel)]="selectedAcademicYear" [options]="academicYears" optionLabel="label"
        placeholder="Select Academic Year" [style]="{'width':'220px'}" styleClass="w-full md:w-auto"
        (ngModelChange)="onAcademicYearChange($event)">
      </p-select>
    </div>

    <div class="text-right">
      <div class="text-sm text-gray-600">Showing calendar for</div>
      <div class="font-semibold">{{ selectedAcademicYear?.label || 'All Years' }}</div>
    </div>
  </div>
</p-card>
<p-card header="Monthly Working Days">
  <!-- Monthly working days bar chart -->
  <div class="mb-4">
    <div style="height:280px;">
      <canvas baseChart [data]="barChartData" [type]="barChartType" [options]="barChartOptions" [plugins]="barChartPlugins">
      </canvas>
    </div>
  </div>
</p-card>
<p-card header="Weekly Offs">
  <hr class="border-t border-gray-200 my-3" />
  <div class="flex flex-wrap gap-2 mb-4">
    <ng-container *ngFor="let d of daysOfWeek">
      <button pButton type="button" (click)="toggleWeeklyDay(d)" [attr.aria-pressed]="isDayOff(d)"
        [ngClass]="[ isDayOff(d) ? 'p-button-primary' : 'p-button-outlined p-button-primary', 'w-full sm:w-auto' ]">
        {{ d.label }}
      </button>
    </ng-container>
  </div>
</p-card>

<!-- Holidays -->
<p-card header="Holidays/Exception working">
  <div class="border-t border-gray-200 my-3"></div>


  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div>
      <label for="holiday-date" class="block font-bold mb-2">Holiday Date <span class="text-red-600">*</span></label>
      <p-datepicker inputId="holiday-date" [(ngModel)]="holidayDate" dateFormat="yy-mm-dd" [style]="{'width':'100%'}"
        styleClass="w-full" [minDate]="minHolidayDate" [maxDate]="maxHolidayDate">
      </p-datepicker>
      <small class="text-xs text-gray-500 mt-1 block">
        <div *ngIf="minHolidayDate || maxHolidayDate" class="flex flex-wrap items-center gap-2">
          <span *ngIf="minHolidayDate">From: {{ minHolidayDate | date:'yyyy-MM-dd' }}</span>
          <span *ngIf="maxHolidayDate">To: {{ maxHolidayDate | date:'yyyy-MM-dd' }}</span>
        </div>
      </small>
    </div>

    <div>
      <label for="holiday-title" class="block font-bold mb-2">Holiday Title <span class="text-red-600">*</span></label>
      <input id="holiday-title" type="text" pInputText [(ngModel)]="holidayTitle" placeholder="Holiday Title"
        class="w-full" />
    </div>

    <div>
      <label for="holiday-type" class="block font-bold mb-2">Type <span class="text-red-600">*</span></label>
      <p-select inputId="holiday-type" [(ngModel)]="holidayType" [options]="holidayTypes" optionLabel="label"
        placeholder="Type" [style]="{'width':'100%'}" styleClass="w-full">
      </p-select>
    </div>

  </div>
  <!-- Range preview controls (client-side only) -->
  <div class="mb-3">
    <div class="flex flex-col md:flex-row md:items-center gap-4">
      <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="rangeMode"
          (ngModelChange)="onRangeModeChange($event)" /> <span>Range</span></label>
      <div *ngIf="rangeMode" class="flex flex-col md:flex-row md:items-center gap-3 w-full">
        <div class="w-full md:w-auto">
          <label class="block font-bold mb-1">End Date</label>
          <p-datepicker [(ngModel)]="holidayEndDate" dateFormat="yy-mm-dd" [minDate]="holidayDate || minHolidayDate"
            [maxDate]="maxHolidayDate" [style]="{'width':'100%'}"></p-datepicker>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="rangeMode && rangePreview?.length" class="mb-4">
    <div class="font-semibold mb-2">Preview ({{ rangePreview.length }} dates)</div>
    <div class="text-xs text-gray-700 max-h-40 overflow-auto">{{ rangePreview.join(', ') }}</div>
  </div>
  <div class="flex justify-start gap-2 mb-4">
    <button *ngIf="!editingHoliday" pButton label="Add Holiday" icon="pi pi-plus" (click)="addHoliday()"
      aria-label="Add Holiday"></button>
    <div *ngIf="editingHoliday" class="flex gap-2">
      <button pButton label="Update Holiday" icon="pi pi-check" (click)="addHoliday()"></button>
      <button pButton label="Cancel" class="p-button-outlined" (click)="cancelEditHoliday()"></button>
    </div>
    <button *ngIf="rangeMode && holidayDate && holidayEndDate" pButton label="Preview" class="p-button-outlined"
      icon="pi pi-eye" (click)="computeRangePreview()"></button>
  </div>
</p-card>
<p-table [value]="holidays" [rows]="10" [paginator]="true" dataKey="id" class="mt-4" stripedRows
  [tableStyle]="{ 'min-width': '60rem' }"
  currentPageReportTemplate="Showing {first} to {last} of {totalRecords} academic years" [showCurrentPageReport]="true"
  [rowsPerPageOptions]="[10,20,30]">
  <ng-template pTemplate="caption">
    <div class="font-bold">Holidays List</div>
  </ng-template>
  <ng-template pTemplate="header">
    <tr>
      <th>Date</th>
      <th>Title</th>
      <th>Type</th>
      <th>Action</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-h>
    <tr>
      <td>{{ h.date }}</td>
      <td>{{ h.title }}</td>
      <td>{{ h.type }}</td>
      <td class="flex gap-2">
        <button pButton icon="pi pi-pencil" [rounded]="true" [outlined]="true" class="p-button-secondary"
          (click)="startEditHoliday(h)"></button>
        <button pButton icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"
          (click)="removeHoliday(h)" [disabled]="editingHoliday && editingHoliday.id === h.id">
        </button>
      </td>
    </tr>
  </ng-template>
</p-table>
<p-toast />
<p-confirmDialog />
<!-- Exception Working Days removed: use holiday.type='WorkingDay' instead -->