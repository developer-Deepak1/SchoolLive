<p-toast></p-toast>
<div class="attendance-page">
	<p-card class="mb-3">
			<div class="p-toolbar-group-left">
				<h3 class="m-0">Student Attendance</h3>
			</div>
			<div class="p-toolbar-group-right">
				<div class="toolbar-grid">
					<div class="toolbar-col">
						<label for="classSelect" class="input-label">Class</label>
						<p-select inputId="classSelect" [options]="classOptions" optionLabel="ClassName" optionValue="ClassID" [(ngModel)]="selectedClass" placeholder="Class" (onChange)="onClassChange()" styleClass="w-full"></p-select>
					</div>
					<div class="toolbar-col">
						<label for="sectionSelect" class="input-label">Section</label>
						<p-select inputId="sectionSelect" [options]="sectionOptions" optionLabel="SectionName" optionValue="SectionID" [(ngModel)]="selectedSection" placeholder="Section" styleClass="w-full" [disabled]="!selectedClass || sectionsLoading()"></p-select>
					</div>
					<div class="toolbar-col">
						<label for="attDate" class="input-label">Date</label>
						<p-datepicker inputId="attDate"  [readonlyInput]="true" [(ngModel)]="dateModel" dateFormat="yy-mm-dd" styleClass="w-full" (onSelect)="checkHoliday($event)" [disabled]="true"></p-datepicker>
					</div>
					<div class="toolbar-actions">
						<p-button label="Search" icon="pi pi-search" (onClick)="search()" styleClass="mr-2 mb-2 w-full sm:w-auto" [disabled]="!selectedClass || !selectedSection || isHoliday()"></p-button>
						<p-button label="Reload" icon="pi pi-refresh" styleClass="mr-2 mb-2 w-full sm:w-auto" (onClick)="load()" [disabled]="!selectedClass || !selectedSection || loading() || saving() || isHoliday()"></p-button>
						<p-button label="{{attendanceTaken() ? 'Updated Attendance' : 'Take Attendance'}}" icon="pi pi-save" (onClick)="save()" styleClass="mb-2 w-full sm:w-auto" [disabled]="saving() || dirtyRows.length===0 || isHoliday()"></p-button>
					</div>
				</div>
			</div>
	</p-card>

	<p-card class="mb-3" *ngIf="attendanceTaken()" header="Attendance Taken">
		<div class="p-d-flex p-ai-center p-jc-between p-text-left p-p-2">
			<div>
				<p-tag severity="warning" value="Attendance already taken for the selected date, class and section. You can modify and save changes."></p-tag>
				<div class="mt-2" *ngIf="takenBy || takenAt">
					<small *ngIf="takenBy">Taken by: <strong>{{ takenBy }}</strong></small>
					<small class="ml-3" *ngIf="takenAt">At: <strong>{{ takenAt }}</strong></small>
				</div>
			</div>
			<div class="p-text-right">
				<!-- reserved for future actions -->
			</div>
		</div>
	</p-card>

		<p-card class="mb-3" *ngIf="isHoliday()" header="Holiday" [style]="{'border-color':'#f59e0b'}">
			<div class="p-p-3">
			<div class="font-semibold">{{ holidayTitle || 'Holiday / Weekly Off' }}</div>
			<div class="text-sm mt-1">Attendance cannot be taken for the selected date.</div>
		</div>
	</p-card>
	<p-card class="mb-3" *ngIf="savedSuccess()" header="Attendance successfully saved">
		<div class="p-d-flex p-flex-column p-p-2">
			<div *ngIf="savedClassName"><strong>Class:</strong> {{ savedClassName }}</div>
			<div *ngIf="savedSectionName"><strong>Section:</strong> {{ savedSectionName }}</div>
			<div *ngIf="takenBy"><strong>Taken by:</strong> {{ takenBy }}</div>
			<div *ngIf="takenAt"><strong>Taken at:</strong> {{ takenAt }}</div>
		</div>
	</p-card>

	<p-table *ngIf="!savedSuccess() && rows().length > 0" [value]="rows()" dataKey="StudentID" [loading]="loading()" [tableStyle]="{'min-width':'100%'}">
		<ng-template pTemplate="header">
			<tr>
				<th style="width:3rem">#</th>
				<th>Student</th>
				<th style="width:10rem">Status</th>
				<th style="width:12rem">Previous Status</th>
			</tr>
		</ng-template>
		<ng-template pTemplate="body" let-row let-i="rowIndex">
			<tr [class.dirty]="row._dirty">
				<td>{{ i+1 }}</td>
				<td>{{ (row.FirstName || '') + (row.MiddleName ? ' ' + row.MiddleName : '') + (row.LastName ? ' ' + row.LastName : '') }}</td>
				<td>
				<p-selectButton [options]="statuses" optionLabel="label" optionValue="value" [(ngModel)]="row.Status" (ngModelChange)="markChanged(row, $event)"></p-selectButton>
				</td>
				<td>
					<span *ngIf="row.PreviousStatus">{{ row.PreviousStatus }}</span>
					<span *ngIf="!row.PreviousStatus">-</span>
				</td>
			</tr>
		</ng-template>
	</p-table>
	<div *ngIf="rows().length > 0" class="legend">
			<span><strong>P</strong> Present</span>
			<span><strong>L</strong> Leave</span>
			<span><strong>H</strong> Half Day</span>
			<span><strong>A</strong> Absent</span>
			<span><strong>-</strong> No Status</span>
			<span class="ml-auto" *ngIf="dirtyRows.length>0">{{ dirtyRows.length }} change(s) pending</span>
	</div>
</div>
